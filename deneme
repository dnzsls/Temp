from datetime import datetime

# 1. Time objesine çevirme fonksiyonu
def time_from_str(time_str):
    return datetime.strptime(str(time_str).strip(), '%H:%M:%S').time() if ':' in str(time_str) else datetime.strptime(str(time_str).strip(), '%H:%M').time()

# 2. Bir saatte hangi shiftler aktif?
def get_active_shifts_from_df(check_hour, df_shifts):
    """
    df_shifts: başlangıç ve bitiş saatleri olan DataFrame
    Kolonlar: 'shift_start', 'shift_end'
    """
    check_time = time_from_str(check_hour)
    active_shift_ids = []
    
    for idx, row in df_shifts.iterrows():
        start_time = row['shift_start']
        end_time = row['shift_end']
        shift_id = row['shift_id']
        
        # Gece vardiyası kontrolü
        if end_time < start_time:
            if check_time >= start_time or check_time < end_time:
                active_shift_ids.append(shift_id)
        else:  # Normal vardiya
            if start_time <= check_time < end_time:
                active_shift_ids.append(shift_id)
    
    return active_shift_ids

# 3. Tüm saatleri oluştur (30 dakikalık)
def generate_hours(interval_minutes=30):
    hours = []
    for h in range(24):
        for m in range(0, 60, interval_minutes):
            hours.append(f"{h:02d}:{m:02d}")
    return hours

# 4. DataFrame'i hazırla
# Shift sütunlarını time objesine çevir
df_tam["shift_start"] = df_tam["shifts_start_hour"].apply(time_from_str)
df_tam["shift_end"] = df_tam["shifts_end_hour"].apply(time_from_str)

# Unique shift ID oluştur (başlangıç + bitiş)
df_tam["shift_id"] = (df_tam["shifts_start_hour"].astype(str).str[:5] + 
                      "-" + 
                      df_tam["shifts_end_hour"].astype(str).str[:5])

# 5. Unique shift'leri bul (aynı shift'i birden fazla saymamak için)
unique_shifts = df_tam[['shift_id', 'shift_start', 'shift_end']].drop_duplicates()

# 6. Otomatik saat_map oluştur
all_hours = generate_hours(interval_minutes=30)  # 30 dakikalık
saat_map = {}

for hour in all_hours:
    saat_map[hour] = get_active_shifts_from_df(hour, unique_shifts)

# Kontrol (opsiyonel)
print("Örnek saat_map çıktısı:")
for hour in ["08:00", "09:00", "17:00", "17:30"]:
    if hour in saat_map:
        print(f"{hour}: {saat_map[hour]}")

# 7. LOKASYON BAZLI hesaplama
rows_lokasyon = []

for day in df_tam["working_day"].unique():
    dfd = df_tam[df_tam["working_day"] == day]
    
    for lokasyon in dfd["lokasyon"].unique():
        subset_lokasyon = dfd[dfd["lokasyon"] == lokasyon]
        
        for out_hour, active_shift_ids in saat_map.items():
            # Bu saatte çalışan shift_id'leri bul
            calisanlar = subset_lokasyon[subset_lokasyon["shift_id"].isin(active_shift_ids)]
            kisi_sayisi = len(calisanlar)
            
            rows_lokasyon.append({
                "tarih": day,
                "lokasyon": lokasyon,
                "saatler": out_hour,
                "calisan_kisi_sayisi": kisi_sayisi
            })

df_lokasyon_bazli = pd.DataFrame(rows_lokasyon).sort_values(["tarih", "lokasyon", "saatler"])

# 8. TOPLAM (Lokasyon olmadan)
rows_toplam = []

for day in df_tam["working_day"].unique():
    dfd = df_tam[df_tam["working_day"] == day]
    
    for out_hour, active_shift_ids in saat_map.items():
        calisanlar = dfd[dfd["shift_id"].isin(active_shift_ids)]
        kisi_sayisi = len(calisanlar)
        
        rows_toplam.append({
            "tarih": day,
            "saatler": out_hour,
            "calisan_kisi_sayisi": kisi_sayisi
        })

df_toplam = pd.DataFrame(rows_toplam).sort_values(["tarih", "saatler"])

# Sonuçları göster
print("\n=== LOKASYON BAZLI ===")
print(df_lokasyon_bazli.head(20))

print("\n=== TOPLAM ===")
print(df_toplam.head(20))
