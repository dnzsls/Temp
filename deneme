"""
KAPASÄ°TE PLANLAMA SÄ°STEMÄ° - V4 (SADELEÅTIRILMIÅ)
Sadece Base Interval + FazlalÄ±k Hesaplama

Ã–zellikler:
- 3 kuyruk desteÄŸi (A, B, C)
- Hafta iÃ§i/sonu ayrÄ±mÄ± (weekday_flg)
- Base ihtiyaÃ§ hesaplama (Erlang C)
- FazlalÄ±k hesaplama (Mevcut kadro - Base)
- YardÄ±mlaÅŸma hesaplama (B ve C â†’ A)

Kurulum:
    pip install pandas openpyxl
"""

import pandas as pd
import math
from datetime import datetime

# ============================================================================
# KONFÄ°GURASYON
# ============================================================================

CONFIG = {
    # Erlang C parametreleri
    'aht': 188,                  # Average Handle Time - saniye
    'target_asa': 30,            # Hedef ASA - saniye
    'target_sl': 0.80,           # Hedef Service Level - %80
    'target_seconds': 30,        # SL iÃ§in hedef sÃ¼re
    'shrinkage': 0.10,           # Mola/izin payÄ± - %10
    'interval_minutes': 60,      # Ä°nterval - dakika
    
    # Mevcut kadro
    'staff': {
        'queue_a': 800,
        'queue_b': 50,
        'queue_c': 100
    },
    
    # YardÄ±mlaÅŸma kurallarÄ±
    'help_rules': {
        'b_helps_a': True,       # B, A'ya yardÄ±m edebilir
        'c_helps_a': True,       # C, A'ya yardÄ±m edebilir
        'weekday_only': True     # Sadece hafta iÃ§i yardÄ±mlaÅŸma
    }
}


# ============================================================================
# BÃ–LÃœM 1: ERLANG C TEMELLERÄ°
# ============================================================================

def erlang_c(agents, traffic):
    """Erlang C: Kuyrukta bekleme olasÄ±lÄ±ÄŸÄ±"""
    if agents <= traffic or agents == 0:
        return 1.0
    
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)


def calculate_asa(agents, traffic, aht):
    """ASA hesapla - saniye"""
    if agents <= traffic or agents == 0:
        return 999
    
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa


def calculate_service_level(agents, traffic, aht, target_seconds):
    """Service Level hesapla"""
    if agents <= traffic or agents == 0:
        return 0.0
    
    ec = erlang_c(agents, traffic)
    exp_term = math.exp(-(agents - traffic) * (target_seconds / aht))
    sl = 1 - (ec * exp_term)
    return max(0, min(1, sl))


def calculate_traffic(calls, interval_min, aht):
    """Traffic (Erlang) hesapla"""
    if calls == 0:
        return 0
    return (calls * (aht / 60)) / interval_min


def find_agents_for_asa(calls, interval_min, aht, target_asa):
    """ASA hedefi iÃ§in gereken agent sayÄ±sÄ±"""
    if calls == 0:
        return 0
    
    traffic = calculate_traffic(calls, interval_min, aht)
    if traffic == 0:
        return 0
    
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 2) + 5
    
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    
    return max_agents


def find_optimal_agents(calls, config):
    """Tek kuyruk iÃ§in optimal agent (shrinkage dahil)"""
    if calls == 0:
        return 0, 0, 0
    
    agents_raw = find_agents_for_asa(
        calls,
        config['interval_minutes'],
        config['aht'],
        config['target_asa']
    )
    
    agents_final = math.ceil(agents_raw / (1 - config['shrinkage']))
    
    traffic = calculate_traffic(calls, config['interval_minutes'], config['aht'])
    final_asa = calculate_asa(agents_raw, traffic, config['aht']) if agents_raw > 0 else 0
    final_sl = calculate_service_level(agents_raw, traffic, config['aht'], config['target_seconds']) if agents_raw > 0 else 0
    
    return agents_final, final_asa, final_sl


# ============================================================================
# BÃ–LÃœM 2: BASE SENARYO - HER KUYRUK Ä°Ã‡Ä°N MÄ°NÄ°MUM Ä°HTÄ°YAÃ‡
# ============================================================================

def calculate_base_requirements(df, config):
    """
    Her kuyruk iÃ§in ayrÄ± ayrÄ± minimum agent ihtiyacÄ±
    YardÄ±mlaÅŸma YOK - saf ihtiyaÃ§
    """
    results = []
    
    for idx, row in df.iterrows():
        date = row['date']
        time = row['time']
        weekday_flg = row.get('weekday_flg', 1)
        
        # Time formatÄ±nÄ± dÃ¼zelt
        if hasattr(time, 'strftime'):
            time = time.strftime('%H:%M')
        elif not isinstance(time, str):
            time = str(time)
        
        # Her kuyruk iÃ§in Ã§aÄŸrÄ± sayÄ±sÄ±
        calls_a = row.get('queue_a', 0)
        calls_b = row.get('queue_b', 0)
        calls_c = row.get('queue_c', 0)
        
        # Her kuyruk iÃ§in base ihtiyaÃ§ hesapla
        agents_a, asa_a, sl_a = find_optimal_agents(calls_a, config)
        agents_b, asa_b, sl_b = find_optimal_agents(calls_b, config)
        agents_c, asa_c, sl_c = find_optimal_agents(calls_c, config)
        
        results.append({
            'date': date,
            'time': time,
            'weekday_flg': weekday_flg,
            # Ã‡aÄŸrÄ± sayÄ±larÄ±
            'calls_a': calls_a,
            'calls_b': calls_b,
            'calls_c': calls_c,
            # Base agent ihtiyaÃ§larÄ±
            'base_agents_a': agents_a,
            'base_agents_b': agents_b,
            'base_agents_c': agents_c,
            'base_total': agents_a + agents_b + agents_c,
            # ASA deÄŸerleri
            'asa_a': round(asa_a, 1),
            'asa_b': round(asa_b, 1),
            'asa_c': round(asa_c, 1),
            # SL deÄŸerleri
            'sl_a': round(sl_a * 100, 1),
            'sl_b': round(sl_b * 100, 1),
            'sl_c': round(sl_c * 100, 1)
        })
    
    return pd.DataFrame(results)


# ============================================================================
# BÃ–LÃœM 3: FAZLALIK HESAPLAMA
# ============================================================================

def calculate_surplus(base_df, config):
    """
    Mevcut kadro vs Base ihtiyaÃ§ karÅŸÄ±laÅŸtÄ±rmasÄ±
    Fazla kapasiteyi bul
    """
    staff = config['staff']
    
    # Hafta iÃ§i ve hafta sonu ayrÄ±
    weekday_df = base_df[base_df['weekday_flg'] == 1]
    weekend_df = base_df[base_df['weekday_flg'] == 0]
    
    # Her kuyruk iÃ§in max base ihtiyaÃ§
    max_base_a = base_df['base_agents_a'].max()
    max_base_b = base_df['base_agents_b'].max()
    max_base_c = base_df['base_agents_c'].max()
    
    # Hafta iÃ§i max
    weekday_max_a = weekday_df['base_agents_a'].max() if len(weekday_df) > 0 else 0
    weekday_max_b = weekday_df['base_agents_b'].max() if len(weekday_df) > 0 else 0
    weekday_max_c = weekday_df['base_agents_c'].max() if len(weekday_df) > 0 else 0
    
    # Hafta sonu max
    weekend_max_a = weekend_df['base_agents_a'].max() if len(weekend_df) > 0 else 0
    weekend_max_b = weekend_df['base_agents_b'].max() if len(weekend_df) > 0 else 0
    weekend_max_c = weekend_df['base_agents_c'].max() if len(weekend_df) > 0 else 0
    
    # Fazla kapasite (hafta iÃ§i yardÄ±ma gidebilecek)
    surplus_b_weekday = max(0, staff['queue_b'] - weekday_max_b)
    surplus_c_weekday = max(0, staff['queue_c'] - weekday_max_c)
    
    surplus = {
        'staff': staff,
        'max_base': {
            'queue_a': max_base_a,
            'queue_b': max_base_b,
            'queue_c': max_base_c
        },
        'weekday_max': {
            'queue_a': weekday_max_a,
            'queue_b': weekday_max_b,
            'queue_c': weekday_max_c
        },
        'weekend_max': {
            'queue_a': weekend_max_a,
            'queue_b': weekend_max_b,
            'queue_c': weekend_max_c
        },
        'surplus_weekday': {
            'queue_b': surplus_b_weekday,
            'queue_c': surplus_c_weekday,
            'total': surplus_b_weekday + surplus_c_weekday
        }
    }
    
    return surplus


# ============================================================================
# BÃ–LÃœM 4: YARDIMLAÅMA UYGULA - FÄ°NAL Ä°HTÄ°YAÃ‡
# ============================================================================

def apply_help_rules(base_df, surplus, config):
    """
    Hafta iÃ§i yardÄ±mlaÅŸmayÄ± uygula
    B ve C fazlasÄ± A'ya yardÄ±m eder
    """
    results = []
    
    help_rules = config['help_rules']
    
    for idx, row in base_df.iterrows():
        weekday_flg = row['weekday_flg']
        
        # Base deÄŸerleri kopyala
        result = {
            'date': row['date'],
            'time': row['time'],
            'weekday_flg': weekday_flg,
            'calls_a': row['calls_a'],
            'calls_b': row['calls_b'],
            'calls_c': row['calls_c'],
            'base_agents_a': row['base_agents_a'],
            'base_agents_b': row['base_agents_b'],
            'base_agents_c': row['base_agents_c'],
            'base_total': row['base_total']
        }
        
        if weekday_flg == 1 and help_rules['weekday_only']:
            # Hafta iÃ§i: YardÄ±mlaÅŸma VAR
            
            # B'nin bu saatteki fazlasÄ±
            b_surplus_now = max(0, config['staff']['queue_b'] - row['base_agents_b'])
            # C'nin bu saatteki fazlasÄ±
            c_surplus_now = max(0, config['staff']['queue_c'] - row['base_agents_c'])
            
            # Toplam yardÄ±m kapasitesi
            help_available = 0
            if help_rules['b_helps_a']:
                help_available += b_surplus_now
            if help_rules['c_helps_a']:
                help_available += c_surplus_now
            
            # A'nÄ±n ihtiyacÄ±ndan yardÄ±mÄ± dÃ¼ÅŸ
            help_used = min(help_available, row['base_agents_a'])
            final_agents_a = max(0, row['base_agents_a'] - help_used)
            
            result['help_from_b'] = min(b_surplus_now, help_used) if help_rules['b_helps_a'] else 0
            result['help_from_c'] = min(c_surplus_now, max(0, help_used - result['help_from_b'])) if help_rules['c_helps_a'] else 0
            result['total_help'] = result['help_from_b'] + result['help_from_c']
            
            result['final_agents_a'] = final_agents_a
            result['final_agents_b'] = row['base_agents_b']
            result['final_agents_c'] = row['base_agents_c']
            result['final_total'] = final_agents_a + row['base_agents_b'] + row['base_agents_c']
            
        else:
            # Hafta sonu: YardÄ±mlaÅŸma YOK
            result['help_from_b'] = 0
            result['help_from_c'] = 0
            result['total_help'] = 0
            result['final_agents_a'] = row['base_agents_a']
            result['final_agents_b'] = row['base_agents_b']
            result['final_agents_c'] = row['base_agents_c']
            result['final_total'] = row['base_total']
        
        results.append(result)
    
    return pd.DataFrame(results)


# ============================================================================
# BÃ–LÃœM 5: RAPORLAMA
# ============================================================================

def print_surplus_report(surplus):
    """FazlalÄ±k raporu"""
    print("\n" + "=" * 60)
    print("ğŸ“Š FAZLALIK RAPORU")
    print("=" * 60)
    
    print("\nğŸ¢ MEVCUT KADRO:")
    for q, count in surplus['staff'].items():
        print(f"   {q}: {count} agent")
    
    print("\nğŸ“ˆ MAX BASE Ä°HTÄ°YAÃ‡ (TÃ¼m DÃ¶nem):")
    for q, count in surplus['max_base'].items():
        print(f"   {q}: {count} agent")
    
    print("\nğŸ“… HAFTA Ä°Ã‡Ä° MAX Ä°HTÄ°YAÃ‡:")
    print(f"   Queue A: {surplus['weekday_max']['queue_a']} agent")
    print(f"   Queue B: {surplus['weekday_max']['queue_b']} agent")
    print(f"   Queue C: {surplus['weekday_max']['queue_c']} agent")
    
    print("\nğŸ“… HAFTA SONU MAX Ä°HTÄ°YAÃ‡:")
    print(f"   Queue A: {surplus['weekend_max']['queue_a']} agent")
    print(f"   Queue B: {surplus['weekend_max']['queue_b']} agent")
    print(f"   Queue C: {surplus['weekend_max']['queue_c']} agent")
    
    print("\nğŸ FAZLA KAPASÄ°TE (Hafta Ä°Ã§i A'ya YardÄ±m):")
    print(f"   Queue B fazlasÄ±: {surplus['surplus_weekday']['queue_b']} agent")
    print(f"   Queue C fazlasÄ±: {surplus['surplus_weekday']['queue_c']} agent")
    print(f"   TOPLAM YARDIM: {surplus['surplus_weekday']['total']} agent")


def print_interval_summary(base_df, final_df):
    """Interval Ã¶zet raporu"""
    print("\n" + "=" * 60)
    print("ğŸ“‹ INTERVAL Ã–ZET")
    print("=" * 60)
    
    print("\nğŸ“Š BASE SENARYO (YardÄ±mlaÅŸma Ã–ncesi):")
    print(f"   Queue A - Ort: {base_df['base_agents_a'].mean():.0f}, Max: {base_df['base_agents_a'].max()}")
    print(f"   Queue B - Ort: {base_df['base_agents_b'].mean():.0f}, Max: {base_df['base_agents_b'].max()}")
    print(f"   Queue C - Ort: {base_df['base_agents_c'].mean():.0f}, Max: {base_df['base_agents_c'].max()}")
    print(f"   TOPLAM  - Ort: {base_df['base_total'].mean():.0f}, Max: {base_df['base_total'].max()}")
    
    print("\nğŸ“Š FÄ°NAL SENARYO (YardÄ±mlaÅŸma SonrasÄ±):")
    print(f"   Queue A - Ort: {final_df['final_agents_a'].mean():.0f}, Max: {final_df['final_agents_a'].max()}")
    print(f"   Queue B - Ort: {final_df['final_agents_b'].mean():.0f}, Max: {final_df['final_agents_b'].max()}")
    print(f"   Queue C - Ort: {final_df['final_agents_c'].mean():.0f}, Max: {final_df['final_agents_c'].max()}")
    print(f"   TOPLAM  - Ort: {final_df['final_total'].mean():.0f}, Max: {final_df['final_total'].max()}")
    
    # Hafta iÃ§i / hafta sonu ayrÄ±mÄ±
    weekday_base = base_df[base_df['weekday_flg'] == 1]
    weekend_base = base_df[base_df['weekday_flg'] == 0]
    weekday_final = final_df[final_df['weekday_flg'] == 1]
    weekend_final = final_df[final_df['weekday_flg'] == 0]
    
    print("\nğŸ“… HAFTA Ä°Ã‡Ä°:")
    print(f"   Base toplam ort: {weekday_base['base_total'].mean():.0f}")
    print(f"   Final toplam ort: {weekday_final['final_total'].mean():.0f}")
    print(f"   YardÄ±m ort: {weekday_final['total_help'].mean():.0f}")
    
    if len(weekend_base) > 0:
        print("\nğŸ“… HAFTA SONU:")
        print(f"   Base toplam ort: {weekend_base['base_total'].mean():.0f}")
        print(f"   Final toplam ort: {weekend_final['final_total'].mean():.0f}")


def export_results(base_df, final_df, surplus):
    """SonuÃ§larÄ± Excel'e kaydet"""
    today = datetime.now().strftime('%Y%m%d')
    
    # Base senaryo
    base_df.to_excel(f'{today}_base_interval.xlsx', index=False)
    
    # Final (yardÄ±mlaÅŸma sonrasÄ±)
    final_df.to_excel(f'{today}_final_interval.xlsx', index=False)
    
    # FazlalÄ±k raporu
    surplus_df = pd.DataFrame([
        {'Metrik': 'Mevcut A', 'DeÄŸer': surplus['staff']['queue_a']},
        {'Metrik': 'Mevcut B', 'DeÄŸer': surplus['staff']['queue_b']},
        {'Metrik': 'Mevcut C', 'DeÄŸer': surplus['staff']['queue_c']},
        {'Metrik': 'Max Base A', 'DeÄŸer': surplus['max_base']['queue_a']},
        {'Metrik': 'Max Base B', 'DeÄŸer': surplus['max_base']['queue_b']},
        {'Metrik': 'Max Base C', 'DeÄŸer': surplus['max_base']['queue_c']},
        {'Metrik': 'Hafta Ä°Ã§i Max A', 'DeÄŸer': surplus['weekday_max']['queue_a']},
        {'Metrik': 'Hafta Ä°Ã§i Max B', 'DeÄŸer': surplus['weekday_max']['queue_b']},
        {'Metrik': 'Hafta Ä°Ã§i Max C', 'DeÄŸer': surplus['weekday_max']['queue_c']},
        {'Metrik': 'Hafta Sonu Max A', 'DeÄŸer': surplus['weekend_max']['queue_a']},
        {'Metrik': 'Hafta Sonu Max B', 'DeÄŸer': surplus['weekend_max']['queue_b']},
        {'Metrik': 'Hafta Sonu Max C', 'DeÄŸer': surplus['weekend_max']['queue_c']},
        {'Metrik': 'B FazlasÄ± (Hafta iÃ§i)', 'DeÄŸer': surplus['surplus_weekday']['queue_b']},
        {'Metrik': 'C FazlasÄ± (Hafta iÃ§i)', 'DeÄŸer': surplus['surplus_weekday']['queue_c']},
        {'Metrik': 'Toplam YardÄ±m Kapasitesi', 'DeÄŸer': surplus['surplus_weekday']['total']}
    ])
    surplus_df.to_excel(f'{today}_fazlalik.xlsx', index=False)
    
    print(f"\nâœ… Dosyalar kaydedildi:")
    print(f"   - {today}_base_interval.xlsx")
    print(f"   - {today}_final_interval.xlsx")
    print(f"   - {today}_fazlalik.xlsx")


# ============================================================================
# ANA FONKSÄ°YON
# ============================================================================

def calculate_base_planning(df):
    """
    Base kapasite planlamasÄ±
    Sadece interval ihtiyaÃ§larÄ± + fazlalÄ±k hesaplama
    """
    
    print("=" * 60)
    print("KAPASÄ°TE PLANLAMA - BASE + FAZLALIK")
    print("=" * 60)
    
    print(f"\nâš™ï¸ KonfigÃ¼rasyon:")
    print(f"   AHT: {CONFIG['aht']} saniye")
    print(f"   Hedef ASA: â‰¤ {CONFIG['target_asa']} saniye")
    print(f"   Shrinkage: %{CONFIG['shrinkage']*100}")
    print(f"   Mevcut Kadro: A={CONFIG['staff']['queue_a']}, B={CONFIG['staff']['queue_b']}, C={CONFIG['staff']['queue_c']}")
    
    # ADIM 1: Base senaryo
    print(f"\nğŸ“Š ADIM 1: Base senaryo hesaplanÄ±yor...")
    base_df = calculate_base_requirements(df, CONFIG)
    print(f"   âœ… {len(base_df)} interval hesaplandÄ±")
    
    # ADIM 2: FazlalÄ±k hesapla
    print(f"\nğŸ“ˆ ADIM 2: FazlalÄ±k hesaplanÄ±yor...")
    surplus = calculate_surplus(base_df, CONFIG)
    
    # ADIM 3: YardÄ±mlaÅŸma uygula
    print(f"\nğŸ¤ ADIM 3: YardÄ±mlaÅŸma uygulanÄ±yor...")
    final_df = apply_help_rules(base_df, surplus, CONFIG)
    
    # Raporlar
    print_surplus_report(surplus)
    print_interval_summary(base_df, final_df)
    
    print("\n" + "=" * 60)
    print("âœ… TAMAMLANDI!")
    print("=" * 60)
    
    return base_df, final_df, surplus


# ============================================================================
# KULLANIM
# ============================================================================

if __name__ == '__main__':
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  KAPASÄ°TE PLANLAMA - BASE + FAZLALIK                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VERÄ° FORMATI:
    Kolonlar: date, time, queue_a, queue_b, queue_c, weekday_flg
    
    weekday_flg: 1 = Hafta iÃ§i, 0 = Hafta sonu

KULLANIM:

# Veriyi oku
df = pd.read_excel('cagri_tahminleri.xlsx')

# Hesapla
base_df, final_df, surplus = calculate_base_planning(df)

# Kaydet
export_results(base_df, final_df, surplus)
""")
