# =============================================================================
# HÃœCRE 1: KÃ¼tÃ¼phaneler
# =============================================================================

import pandas as pd
import numpy as np
import math
from datetime import datetime

print("KÃ¼tÃ¼phaneler yÃ¼klendi âœ“")


# =============================================================================
# HÃœCRE 2: KONFÄ°GÃœRASYON (BURAYI GÃœNCELLE)
# =============================================================================

CONFIG = {
    # Erlang C parametreleri
    'aht': {
        'A': 188,    # TODO: Kuyruk A iÃ§in gerÃ§ek AHT (saniye)
        'B': 188,    # TODO: Kuyruk B iÃ§in gerÃ§ek AHT (saniye)
        'C': 188     # TODO: Kuyruk C iÃ§in gerÃ§ek AHT (saniye)
    },
    'target_asa': 30,            # Hedef ASA - saniye
    'target_sl': 0.80,           # Hedef Service Level - %80
    'target_seconds': 30,        # SL iÃ§in hedef sÃ¼re
    'shrinkage': 0.10,           # Mola/izin payÄ± - %10
    'interval_minutes': 30,      # Ä°nterval - 30 dakika
    
    # YardÄ±mlaÅŸma kurallarÄ±
    'help_rules': {
        'b_helps_a': True,       # B, A'ya yardÄ±m edebilir
        'c_helps_a': True,       # C, A'ya yardÄ±m edebilir
        'weekday_only': True     # Sadece hafta iÃ§i yardÄ±mlaÅŸma
    }
}

print("KonfigÃ¼rasyon:")
print(f"  AHT A: {CONFIG['aht']['A']} sn ({CONFIG['aht']['A']/60:.1f} dk)")
print(f"  AHT B: {CONFIG['aht']['B']} sn ({CONFIG['aht']['B']/60:.1f} dk)")
print(f"  AHT C: {CONFIG['aht']['C']} sn ({CONFIG['aht']['C']/60:.1f} dk)")
print(f"  Hedef ASA: â‰¤ {CONFIG['target_asa']} saniye")
print(f"  Hedef SL: %{CONFIG['target_sl']*100:.0f} / {CONFIG['target_seconds']} saniye")
print(f"  Shrinkage: %{CONFIG['shrinkage']*100:.0f}")
print(f"  Ä°nterval: {CONFIG['interval_minutes']} dakika")


# =============================================================================
# HÃœCRE 3: ERLANG C FONKSÄ°YONLARI
# =============================================================================

def erlang_c(agents, traffic):
    """Erlang C: Kuyrukta bekleme olasÄ±lÄ±ÄŸÄ±"""
    if agents <= traffic or agents == 0:
        return 1.0
    
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)


def calculate_asa(agents, traffic, aht):
    """ASA hesapla - saniye"""
    if agents <= traffic or agents == 0:
        return 999
    
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa


def calculate_service_level(agents, traffic, aht, target_seconds):
    """Service Level hesapla"""
    if agents <= traffic or agents == 0:
        return 0.0
    
    ec = erlang_c(agents, traffic)
    exp_term = math.exp(-(agents - traffic) * (target_seconds / aht))
    sl = 1 - (ec * exp_term)
    return max(0, min(1, sl))


def calculate_traffic(calls, interval_min, aht):
    """Traffic (Erlang) hesapla"""
    if calls == 0:
        return 0
    return (calls * (aht / 60)) / interval_min


def find_agents_for_asa(calls, interval_min, aht, target_asa):
    """ASA hedefi iÃ§in gereken agent sayÄ±sÄ±"""
    if calls == 0:
        return 0
    
    traffic = calculate_traffic(calls, interval_min, aht)
    if traffic == 0:
        return 0
    
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 3) + 10
    
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    
    return max_agents


def find_optimal_agents(calls, aht, config):
    """Tek kuyruk iÃ§in optimal agent (shrinkage dahil)"""
    if calls == 0:
        return 0, 0, 0
    
    agents_raw = find_agents_for_asa(
        calls,
        config['interval_minutes'],
        aht,
        config['target_asa']
    )
    
    agents_final = math.ceil(agents_raw / (1 - config['shrinkage']))
    
    traffic = calculate_traffic(calls, config['interval_minutes'], aht)
    final_asa = calculate_asa(agents_raw, traffic, aht) if agents_raw > 0 else 0
    final_sl = calculate_service_level(agents_raw, traffic, aht, config['target_seconds']) if agents_raw > 0 else 0
    
    return agents_final, final_asa, final_sl

print("Erlang C fonksiyonlarÄ± tanÄ±mlandÄ± âœ“")


# =============================================================================
# HÃœCRE 4: VERÄ° HAZIRLAMA FONKSÄ°YONLARI
# =============================================================================

def convert_15_to_30_calls(df_15):
    """15 dakikalÄ±k Ã§aÄŸrÄ± verisini 30 dakikalÄ±ÄŸa Ã§evirir"""
    
    df = df_15.copy()
    
    # Tarih ve saat iÅŸleme
    df['data_date'] = pd.to_datetime(df['data_date'])
    
    # time_period'dan saat ve dakika Ã§Ä±kar
    if df['time_period'].dtype == 'object':
        df['hour'] = df['time_period'].str.split(':').str[0].astype(int)
        df['minute'] = df['time_period'].str.split(':').str[1].astype(int)
    else:
        # datetime formatÄ±nda ise
        df['hour'] = pd.to_datetime(df['time_period'].astype(str)).dt.hour
        df['minute'] = pd.to_datetime(df['time_period'].astype(str)).dt.minute
    
    # 30 dakikalÄ±k slot oluÅŸtur (00-29 â†’ 00, 30-59 â†’ 30)
    df['slot_30'] = df['hour'].astype(str).str.zfill(2) + ':' + \
                    ((df['minute'] // 30) * 30).astype(str).str.zfill(2)
    
    # HaftanÄ±n gÃ¼nÃ¼ (5=Cumartesi, 6=Pazar)
    df['day_of_week'] = df['data_date'].dt.dayofweek
    df['weekday_flg'] = (df['day_of_week'] < 5).astype(int)  # 1=HaftaiÃ§i, 0=Haftasonu
    
    # 30 dakikalÄ±k aggregate (Ã§aÄŸrÄ±larÄ± topla)
    df_30 = df.groupby(['data_date', 'slot_30', 'weekday_flg']).agg({
        'a_nof_call': 'sum',
        'b_nof_call': 'sum',
        'c_nof_call': 'sum'
    }).reset_index()
    
    # Kolon isimlerini dÃ¼zenle
    df_30.columns = ['data_date', 'slot_30', 'weekday_flg', 'calls_a', 'calls_b', 'calls_c']
    
    return df_30.sort_values(['data_date', 'slot_30']).reset_index(drop=True)


def prepare_staffing_data(df_staff):
    """
    Staffing verisini pivot yaparak kuyruk bazlÄ± agent sayÄ±larÄ±na Ã§evirir
    
    Input kolonlarÄ±: working_date, line_based_main_group, saatler, calisan_kisi_sayisi
    Output kolonlarÄ±: data_date, slot_30, a_agents, b_agents, c_agents
    """
    
    df = df_staff.copy()
    
    # Kolon isimlerini standartlaÅŸtÄ±r
    df = df.rename(columns={
        'working_date': 'data_date',
        'saatler': 'slot_30',
        'calisan_kisi_sayisi': 'agent_count'
    })
    
    # Tarih formatÄ±nÄ± dÃ¼zenle
    df['data_date'] = pd.to_datetime(df['data_date'])
    
    # Saat formatÄ±nÄ± dÃ¼zenle (HH:MM olmalÄ±)
    if df['slot_30'].dtype != 'object':
        df['slot_30'] = df['slot_30'].astype(str)
    df['slot_30'] = df['slot_30'].str[:5]  # Ä°lk 5 karakter (HH:MM)
    
    # line_based_main_group deÄŸerlerini standartlaÅŸtÄ±r
    # a_cagrilari, b_cagrilar, c_cagrilar gibi deÄŸerleri A, B, C'ye Ã§evir
    df['queue'] = df['line_based_main_group'].str.lower().str[0].str.upper()  # Ä°lk harf: A, B veya C
    
    # Pivot: Her satÄ±rda tarih + saat, kolonlarda A, B, C agent sayÄ±larÄ±
    df_pivot = df.pivot_table(
        index=['data_date', 'slot_30'],
        columns='queue',
        values='agent_count',
        aggfunc='sum',
        fill_value=0
    ).reset_index()
    
    # Kolon isimlerini dÃ¼zenle
    df_pivot.columns.name = None
    df_pivot = df_pivot.rename(columns={
        'A': 'a_agents',
        'B': 'b_agents',
        'C': 'c_agents'
    })
    
    # Eksik kuyruk kolonlarÄ±nÄ± ekle (eÄŸer yoksa)
    for col in ['a_agents', 'b_agents', 'c_agents']:
        if col not in df_pivot.columns:
            df_pivot[col] = 0
    
    return df_pivot.sort_values(['data_date', 'slot_30']).reset_index(drop=True)

print("Veri hazÄ±rlama fonksiyonlarÄ± tanÄ±mlandÄ± âœ“")


# =============================================================================
# HÃœCRE 5: Ã‡AÄRI VERÄ°SÄ°NÄ° YÃœKLE (15 DAKÄ°KALIK HAM VERÄ°)
# =============================================================================

# SQL'den gelen 15 dakikalÄ±k Ã§aÄŸrÄ± verisi
# Kolonlar: data_date, time_period, a_nof_call, b_nof_call, c_nof_call

# SEÃ‡ENEK A: CSV'den oku
# df_calls_15 = pd.read_csv('cagri_verisi.csv')

# SEÃ‡ENEK B: Direkt DataFrame oluÅŸtur (test iÃ§in Ã¶rnek veri - SÄ°L VE KENDÄ° VERÄ°NÄ° YAZ)
df_calls_15 = pd.DataFrame({
    'data_date': ['2024-01-06']*8,  # Cumartesi
    'time_period': ['09:00', '09:15', '09:30', '09:45', '10:00', '10:15', '10:30', '10:45'],
    'a_nof_call': [22, 23, 25, 27, 24, 24, 26, 22],
    'b_nof_call': [14, 14, 15, 16, 14, 15, 14, 15],
    'c_nof_call': [7, 8, 9, 9, 8, 8, 7, 9]
})

print(f"15dk'lÄ±k Ã§aÄŸrÄ± verisi yÃ¼klendi: {len(df_calls_15)} satÄ±r")
print(f"Tarih aralÄ±ÄŸÄ±: {df_calls_15['data_date'].min()} - {df_calls_15['data_date'].max()}")
df_calls_15.head()


# =============================================================================
# HÃœCRE 6: STAFFING VERÄ°SÄ°NÄ° YÃœKLE (Ã‡ALIÅAN SAYISI VERÄ°SÄ°)
# =============================================================================

# SQL'den gelen staffing verisi
# Kolonlar: working_date, line_based_main_group, saatler, calisan_kisi_sayisi

# SEÃ‡ENEK A: CSV'den oku
# df_staff_raw = pd.read_csv('staffing_verisi.csv')

# SEÃ‡ENEK B: Direkt DataFrame oluÅŸtur (test iÃ§in Ã¶rnek veri - SÄ°L VE KENDÄ° VERÄ°NÄ° YAZ)
df_staff_raw = pd.DataFrame({
    'working_date': ['2024-01-06']*6,  # Cumartesi
    'line_based_main_group': ['a_cagrilari', 'a_cagrilari', 'b_cagrilar', 'b_cagrilar', 'c_cagrilar', 'c_cagrilar'],
    'saatler': ['09:00', '09:30', '09:00', '09:30', '09:00', '09:30'],
    'calisan_kisi_sayisi': [12, 14, 8, 8, 5, 6]
})

print(f"Staffing ham verisi yÃ¼klendi: {len(df_staff_raw)} satÄ±r")
print(f"Tarih aralÄ±ÄŸÄ±: {df_staff_raw['working_date'].min()} - {df_staff_raw['working_date'].max()}")
print(f"Kuyruklar: {df_staff_raw['line_based_main_group'].unique()}")
df_staff_raw.head()


# =============================================================================
# HÃœCRE 7: VERÄ° DÃ–NÃœÅÃœMÃœ
# =============================================================================

# Ã‡aÄŸrÄ± verisini 30dk'ya Ã§evir
df_calls_30 = convert_15_to_30_calls(df_calls_15)
print(f"30dk'lÄ±k Ã§aÄŸrÄ± verisi: {len(df_calls_30)} satÄ±r")

# Sadece haftasonu filtrele (validasyon iÃ§in)
df_calls_weekend = df_calls_30[df_calls_30['weekday_flg'] == 0].copy()
print(f"Haftasonu Ã§aÄŸrÄ± verisi: {len(df_calls_weekend)} satÄ±r")

# Staffing verisini pivot yap
df_staffing = prepare_staffing_data(df_staff_raw)
print(f"Staffing verisi hazÄ±rlandÄ±: {len(df_staffing)} satÄ±r")

print("\nğŸ“‹ Ã‡aÄŸrÄ± verisi Ã¶rnek:")
display(df_calls_weekend.head()) if 'display' in dir() else print(df_calls_weekend.head())

print("\nğŸ“‹ Staffing verisi Ã¶rnek:")
display(df_staffing.head()) if 'display' in dir() else print(df_staffing.head())


# =============================================================================
# HÃœCRE 8: VERÄ°LERÄ° BÄ°RLEÅTÄ°R
# =============================================================================

# Tarih formatÄ±nÄ± eÅŸitle
df_calls_weekend['data_date'] = pd.to_datetime(df_calls_weekend['data_date']).dt.strftime('%Y-%m-%d')
df_staffing['data_date'] = pd.to_datetime(df_staffing['data_date']).dt.strftime('%Y-%m-%d')

# BirleÅŸtir
df_merged = pd.merge(
    df_calls_weekend,
    df_staffing[['data_date', 'slot_30', 'a_agents', 'b_agents', 'c_agents']],
    on=['data_date', 'slot_30'],
    how='left'
)

# Eksik staffing deÄŸerlerini 0 yap
df_merged[['a_agents', 'b_agents', 'c_agents']] = df_merged[['a_agents', 'b_agents', 'c_agents']].fillna(0).astype(int)

print(f"BirleÅŸtirilmiÅŸ veri: {len(df_merged)} satÄ±r")
df_merged.head(10)


# =============================================================================
# HÃœCRE 9: ERLANG C HESAPLA VE KARÅILAÅTIR
# =============================================================================

results = []

for idx, row in df_merged.iterrows():
    for queue in ['A', 'B', 'C']:
        calls_col = f'calls_{queue.lower()}'
        agents_col = f'{queue.lower()}_agents'
        
        calls = row[calls_col]
        actual_agents = row[agents_col]
        aht = CONFIG['aht'][queue]
        
        # Erlang C tahmini (shrinkage dahil)
        erlang_need, expected_asa, expected_sl = find_optimal_agents(calls, aht, CONFIG)
        
        # Shrinkage'sÄ±z ham ihtiyaÃ§ (karÅŸÄ±laÅŸtÄ±rma iÃ§in)
        erlang_raw = find_agents_for_asa(calls, CONFIG['interval_minutes'], aht, CONFIG['target_asa'])
        
        # Fark hesapla
        diff = actual_agents - erlang_need
        diff_raw = actual_agents - erlang_raw
        
        # GerÃ§ek SL tahmini (mevcut agent sayÄ±sÄ±yla)
        if calls > 0 and actual_agents > 0:
            traffic = calculate_traffic(calls, CONFIG['interval_minutes'], aht)
            achieved_sl = calculate_service_level(actual_agents, traffic, aht, CONFIG['target_seconds'])
            achieved_asa = calculate_asa(actual_agents, traffic, aht)
        else:
            achieved_sl = 1.0
            achieved_asa = 0
        
        results.append({
            'date': row['data_date'],
            'slot_30': row['slot_30'],
            'queue': queue,
            'calls': calls,
            'aht_sec': aht,
            # Erlang sonuÃ§larÄ±
            'erlang_raw': erlang_raw,           # Shrinkage'sÄ±z
            'erlang_need': erlang_need,         # Shrinkage dahil
            # GerÃ§ek deÄŸerler
            'actual_agents': actual_agents,
            # Farklar
            'diff_vs_raw': diff_raw,            # GerÃ§ek - Raw
            'diff_vs_need': diff,               # GerÃ§ek - Shrinkage dahil
            # Metrikler
            'expected_sl': round(expected_sl * 100, 1),
            'achieved_sl': round(achieved_sl * 100, 1),
            'expected_asa': round(expected_asa, 1),
            'achieved_asa': round(achieved_asa, 1) if achieved_asa < 999 else 999
        })

df_comparison = pd.DataFrame(results)
print(f"KarÅŸÄ±laÅŸtÄ±rma tamamlandÄ±: {len(df_comparison)} satÄ±r")
df_comparison.head(10)


# =============================================================================
# HÃœCRE 10: GENEL Ã–ZET RAPOR
# =============================================================================

print("=" * 70)
print("ERLANG C VALÄ°DASYON RAPORU - GENEL Ã–ZET")
print("=" * 70)

# Sadece Ã§aÄŸrÄ± olan slotlarÄ± filtrele
df_with_calls = df_comparison[df_comparison['calls'] > 0]

print(f"\nğŸ“Š VERÄ° Ã–ZETÄ°:")
print(f"   Toplam slot: {len(df_comparison)}")
print(f"   Ã‡aÄŸrÄ± olan slot: {len(df_with_calls)}")
print(f"   Toplam Ã§aÄŸrÄ±: {df_with_calls['calls'].sum():.0f}")

print(f"\nğŸ“ˆ ERLANG vs GERÃ‡EK KARÅILAÅTIRMA (Shrinkage dahil):")
print(f"   Ortalama fark (actual - erlang_need): {df_with_calls['diff_vs_need'].mean():.2f}")
print(f"   Understaffed slot: {len(df_with_calls[df_with_calls['diff_vs_need'] < 0])} ({len(df_with_calls[df_with_calls['diff_vs_need'] < 0])/len(df_with_calls)*100:.1f}%)")
print(f"   Overstaffed slot: {len(df_with_calls[df_with_calls['diff_vs_need'] > 0])} ({len(df_with_calls[df_with_calls['diff_vs_need'] > 0])/len(df_with_calls)*100:.1f}%)")
print(f"   Tam eÅŸleÅŸme: {len(df_with_calls[df_with_calls['diff_vs_need'] == 0])}")

print(f"\nğŸ“ˆ ERLANG vs GERÃ‡EK KARÅILAÅTIRMA (Shrinkage'sÄ±z - Raw):")
print(f"   Ortalama fark (actual - erlang_raw): {df_with_calls['diff_vs_raw'].mean():.2f}")
print(f"   Understaffed slot: {len(df_with_calls[df_with_calls['diff_vs_raw'] < 0])}")
print(f"   Overstaffed slot: {len(df_with_calls[df_with_calls['diff_vs_raw'] > 0])}")

print(f"\nğŸ¯ SERVÄ°S SEVÄ°YESÄ°:")
print(f"   Ortalama beklenen SL: %{df_with_calls['expected_sl'].mean():.1f}")
print(f"   Ortalama gerÃ§ekleÅŸen SL (tahmini): %{df_with_calls['achieved_sl'].mean():.1f}")


# =============================================================================
# HÃœCRE 11: KUYRUK BAZINDA Ã–ZET
# =============================================================================

print("\n" + "=" * 70)
print("KUYRUK BAZINDA Ã–ZET")
print("=" * 70)

for queue in ['A', 'B', 'C']:
    q_data = df_with_calls[df_with_calls['queue'] == queue]
    if len(q_data) > 0:
        print(f"\nğŸ“Œ KUYRUK {queue}:")
        print(f"   Ort. Ã‡aÄŸrÄ±: {q_data['calls'].mean():.1f}")
        print(f"   Ort. Erlang (raw): {q_data['erlang_raw'].mean():.1f}")
        print(f"   Ort. Erlang (shrinkage dahil): {q_data['erlang_need'].mean():.1f}")
        print(f"   Ort. GerÃ§ek Agent: {q_data['actual_agents'].mean():.1f}")
        print(f"   Ort. Fark (vs raw): {q_data['diff_vs_raw'].mean():.2f}")
        print(f"   Ort. Fark (vs need): {q_data['diff_vs_need'].mean():.2f}")
        print(f"   Ort. GerÃ§ekleÅŸen SL: %{q_data['achieved_sl'].mean():.1f}")


# =============================================================================
# HÃœCRE 12: PROBLEMLÄ° SLOTLAR
# =============================================================================

print("\n" + "=" * 70)
print("PROBLEMLÄ° SLOTLAR")
print("=" * 70)

# Ciddi understaffing (Erlang raw'dan bile dÃ¼ÅŸÃ¼k)
print("\nâš ï¸ CÄ°DDÄ° UNDERSTAFFING (actual < erlang_raw):")
serious_under = df_with_calls[df_with_calls['diff_vs_raw'] < -2].sort_values('diff_vs_raw')
if len(serious_under) > 0:
    print(serious_under[['date', 'slot_30', 'queue', 'calls', 'erlang_raw', 'actual_agents', 'diff_vs_raw', 'achieved_sl']].head(10).to_string(index=False))
else:
    print("   Ciddi understaffing bulunamadÄ± âœ“")

# DÃ¼ÅŸÃ¼k SL
print("\nâš ï¸ DÃœÅÃœK SERVÄ°S SEVÄ°YESÄ° (SL < %70):")
low_sl = df_with_calls[df_with_calls['achieved_sl'] < 70].sort_values('achieved_sl')
if len(low_sl) > 0:
    print(low_sl[['date', 'slot_30', 'queue', 'calls', 'actual_agents', 'achieved_sl', 'achieved_asa']].head(10).to_string(index=False))
else:
    print("   DÃ¼ÅŸÃ¼k SL bulunamadÄ± âœ“")


# =============================================================================
# HÃœCRE 13: SAAT BAZINDA ANALÄ°Z
# =============================================================================

print("\n" + "=" * 70)
print("SAAT BAZINDA ORTALAMA")
print("=" * 70)

hourly_analysis = df_with_calls.groupby('slot_30').agg({
    'calls': 'mean',
    'erlang_raw': 'mean',
    'actual_agents': 'mean',
    'diff_vs_raw': 'mean',
    'achieved_sl': 'mean'
}).round(1)

hourly_analysis.columns = ['Ort.Ã‡aÄŸrÄ±', 'Erlang', 'GerÃ§ek', 'Fark', 'SL%']
print(hourly_analysis.to_string())


# =============================================================================
# HÃœCRE 14: GÃ–RSELLEÅTÄ°RME
# =============================================================================

import matplotlib.pyplot as plt

fig, axes = plt.subplots(2, 3, figsize=(15, 10))

# Ãœst satÄ±r: Erlang vs Actual scatter
for i, queue in enumerate(['A', 'B', 'C']):
    q_data = df_with_calls[df_with_calls['queue'] == queue]
    
    if len(q_data) > 0:
        axes[0, i].scatter(q_data['erlang_raw'], q_data['actual_agents'], alpha=0.5, label='Raw')
        
        # 45 derece Ã§izgisi (mÃ¼kemmel eÅŸleÅŸme)
        max_val = max(q_data['erlang_raw'].max(), q_data['actual_agents'].max())
        axes[0, i].plot([0, max_val], [0, max_val], 'r--', label='MÃ¼kemmel eÅŸleÅŸme')
        
        axes[0, i].set_xlabel('Erlang Tahmini (Raw)')
        axes[0, i].set_ylabel('GerÃ§ek Agent')
        axes[0, i].set_title(f'Kuyruk {queue}')
        axes[0, i].legend()
        axes[0, i].grid(True, alpha=0.3)

# Alt satÄ±r: Fark histogramÄ±
for i, queue in enumerate(['A', 'B', 'C']):
    q_data = df_with_calls[df_with_calls['queue'] == queue]
    
    if len(q_data) > 0:
        axes[1, i].hist(q_data['diff_vs_raw'], bins=20, edgecolor='black', alpha=0.7)
        axes[1, i].axvline(x=0, color='r', linestyle='--', label='SÄ±fÄ±r fark')
        axes[1, i].axvline(x=q_data['diff_vs_raw'].mean(), color='g', linestyle='-', label=f'Ortalama: {q_data["diff_vs_raw"].mean():.1f}')
        axes[1, i].set_xlabel('Fark (GerÃ§ek - Erlang)')
        axes[1, i].set_ylabel('Slot SayÄ±sÄ±')
        axes[1, i].set_title(f'Kuyruk {queue} - Fark DaÄŸÄ±lÄ±mÄ±')
        axes[1, i].legend()
        axes[1, i].grid(True, alpha=0.3)

plt.tight_layout()
plt.show()


# =============================================================================
# HÃœCRE 15: SONUÃ‡LARI KAYDET (OPSÄ°YONEL)
# =============================================================================

# Excel'e kaydet
# df_comparison.to_excel('erlang_validation_results.xlsx', index=False)
# print("SonuÃ§lar 'erlang_validation_results.xlsx' dosyasÄ±na kaydedildi")

# Ã–zet istatistikler
print("\n" + "=" * 70)
print("VALÄ°DASYON SONUCU")
print("=" * 70)

avg_diff = df_with_calls['diff_vs_raw'].mean()

if abs(avg_diff) < 1:
    print("âœ… MÃœKEMMEL: Erlang tahminleri gerÃ§ek deÄŸerlerle Ã§ok uyumlu!")
elif abs(avg_diff) < 3:
    print("ğŸ‘ Ä°YÄ°: Erlang tahminleri kabul edilebilir seviyede.")
elif avg_diff > 3:
    print("âš ï¸ OVERSTAFFING: GerÃ§ekte Erlang'Ä±n Ã¶nerdiÄŸinden fazla kiÅŸi Ã§alÄ±ÅŸÄ±yor.")
else:
    print("âš ï¸ UNDERSTAFFING: GerÃ§ekte Erlang'Ä±n Ã¶nerdiÄŸinden az kiÅŸi Ã§alÄ±ÅŸÄ±yor.")

print(f"\n   Ortalama fark: {avg_diff:.2f} agent")
print(f"   Yorum: {'Fazla' if avg_diff > 0 else 'Eksik'} Ã§alÄ±ÅŸan eÄŸilimi var.")
