import pandas as pd
from datetime import datetime

# Shift sütununu time formatına çevir
df_tam["shifts_start_hour"] = df_tam["shifts_start_hour"].apply(
    lambda x: datetime.strptime(str(x).strip(), '%H:%M:%S').time() if pd.notna(x) else None
)

# Shift sütununu HH:MM formatına çevir (saat_map ile eşleşmek için)
df_tam["shift_key"] = df_tam["shifts_start_hour"].astype(str).str[:5]  # "08:00:00" -> "08:00"

# LOKASYON BAZLI
rows_lokasyon = []

for day in df_tam["working_day"].unique():
    dfd = df_tam[df_tam["working_day"] == day]
    
    for lokasyon in dfd["lokasyon"].unique():
        subset_lokasyon = dfd[dfd["lokasyon"] == lokasyon]
        
        for out_hour, start_list in saat_map.items():
            # Bu saatte çalışan shiftleri bul
            calisanlar = subset_lokasyon[subset_lokasyon["shift_key"].isin(start_list)]
            kisi_sayisi = len(calisanlar)
            
            rows_lokasyon.append({
                "tarih": day,
                "lokasyon": lokasyon,
                "saatler": out_hour,
                "calisan_kisi_sayisi": kisi_sayisi
            })

df_lokasyon_bazli = pd.DataFrame(rows_lokasyon).sort_values(["tarih", "lokasyon", "saatler"])

# TOPLAM (Lokasyon olmadan)
rows_toplam = []

for day in df_tam["working_day"].unique():
    dfd = df_tam[df_tam["working_day"] == day]
    
    for out_hour, start_list in saat_map.items():
        calisanlar = dfd[dfd["shift_key"].isin(start_list)]
        kisi_sayisi = len(calisanlar)
        
        rows_toplam.append({
            "tarih": day,
            "saatler": out_hour,
            "calisan_kisi_sayisi": kisi_sayisi
        })

df_toplam = pd.DataFrame(rows_toplam).sort_values(["tarih", "saatler"])

# Sonuçları göster
print("LOKASYON BAZLI:")
print(df_lokasyon_bazli.head(20))
print("\nTOPLAM:")
print(df_toplam.head(20))